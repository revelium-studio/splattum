# Dockerfile for RunPod Serverless SHARP ML Handler
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    wget \
    ffmpeg \
    libsm6 \
    libxext6 \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip install --no-cache-dir \
    runpod \
    torch \
    torchvision \
    numpy \
    scipy \
    pillow \
    pillow-heif \
    plyfile \
    click \
    tqdm \
    timm \
    matplotlib \
    imageio \
    imageio-ffmpeg \
    huggingface_hub

# Install SHARP ML
RUN pip install git+https://github.com/apple/ml-sharp.git

# Create cache directory for models
RUN mkdir -p /cache/torch /cache/huggingface

# Set environment variables
ENV TORCH_HOME=/cache/torch
ENV HF_HOME=/cache/huggingface
ENV PYTHONUNBUFFERED=1

# Set working directory
WORKDIR /app

# Copy handler script to working directory
COPY runpod_handler.py /app/handler.py

# RunPod serverless handler entry point
# The handler.py file should have: runpod.serverless.start({"handler": handler})
CMD ["python", "-u", "/app/handler.py"]
